# hyperledger1.0分布式环境搭建

本篇主要介绍`hyperledger1.0`基本环境的搭建，看了一些现有的教程啥的，都是基于官方的一键脚本运行的，脚本里面基本都已经写好了如何配置参数，甚至自动组建区块链的环境都已经使用脚本做好的，本篇笔者通过阅读官方的脚本逐步搭建出一个多个节点参与非容器环境的超级账本环境，以及使用`Fabric-CA`模块实现用户注册等等。至于相关区块链的原理以及超级账本所使用的组件功能配置，在后面的学习笔记中会进行记录与解释。

## 一、基本环境简介

![](img/区块链网络构架图.png)

如上图所示，在实验环境中我们将实现如上图所示的区块链结构，因为是实验环境，资源有限，所以在排序服务我们先暂时使用单节点实现，先验证功能。如上图所示，图中的`组织1`和`组织2`就是组成联盟链中的成员。为了演示以及验证超级账本中的各个节点的功能，我们可以在每一个组织节点中放入两个节点。

## 二、基本环境准备

超级账本使用`Go`语言实现，`Go`语言会将最后的程序代码编译为二进制文件，所以在环境上我们需要在环境中安装`docker`(因为超级账本的链码背书环节需要用到docker环境)，详细的环境依赖可以参考[官网连接](http://hyperledger-fabric.readthedocs.io/en/v1.0.6/prereqs.html#), 因为本实验的环境是基于非容器环境的，意思是超级账本本身是不运行在容器中的(但是在执行链码时却是运行在docker环境中的，下面会有演示)，所以先要准备超级账本编译好的二进制包。官方给我们提供了一个下载脚本完成。

```bash
Shell> curl -sSL https://goo.gl/kFFqh5 | bash -s 1.0.6    #该版本是本文在编写时可以使用的版本
Shell> git clone https://github.com/hyperledger/fabric-samples.git # 下载演示工程目录，我们要搭建的环境其实就是自己阅读一遍这里的代码然后自己模拟一下这个搭建过程
```

如上命令执行完成后会在当前目录下自定新建一个`bin`目录里面包含了`超级账本`运行时所要依赖到的二进制文件。
```bash
[root@localhost fabric]# tree 
.
└── bin
    ├── configtxgen #生成组织配置文件以及初始创世纪块时需要用到
    ├── configtxlator
    ├── cryptogen # 生成超级账本中组织结构管理信任关系证书的工具，在初期实验是比较使用到，后期上线面对联盟链场景中拓展则需要专业的CA组件
    ├── get-byfn.sh
    ├── get-docker-images.sh
    ├── orderer   # 排序服务实现二进制文件
    └── peer      # peer节点实现二进制文件
```

## 三、分布式环境搭建步骤


### 3.1、准备联盟链模板以及配置文件

`Fabric`的认证以组织机构的身份验证管理依靠证书实现，即组织机构的层级关系是通过证书实现的，节点的加入与控制基于`CA`签发的证书，比较的严格。首先官方给我们提供了一个工具`cryptogen`来自动生成组织机构关系，该工具依赖于`crypto-config.yaml`配置文件，在本工程的示例文件中给出了一个配置文件模板，笔者也是基于该配置文件的组织机构构建超级账本的组织机构，笔者会根据在实际的调用过程中使用到的配置加以解释，其他配置会不断的丰富完善。模板配置文件`crypto-config.yaml`如下：

```bash
# ---------------------------------------------------------------------------
# "OrdererOrgs" - Definition of organizations managing orderer nodes
# ---------------------------------------------------------------------------
OrdererOrgs:
  # ---------------------------------------------------------------------------
  # Orderer
  # ---------------------------------------------------------------------------
  - Name: Orderer
    Domain: epoint.com.cn
    Template:
      Count: 4  # 定义在超级账本中包含了几个Orderer共识节点
# ---------------------------------------------------------------------------
# "PeerOrgs" - Definition of organizations managing peer nodes
# ---------------------------------------------------------------------------
PeerOrgs:
  # ---------------------------------------------------------------------------
  # Org1
  # ---------------------------------------------------------------------------
  - Name: city1            # 组织机构名称
    Domain: city1.epoint.com.cn    #组织机构的域名，请注意该属性请不要随意的去配置，后面需要使用到
    Template:
      Count: 2             # 该属性表示该机构下有几个组织节点
    Users:
      Count: 5             # 该属性表示该组织机构下包含了多少个用户，其中会自动签发一个管理员用户供给配置管理使用
  # ---------------------------------------------------------------------------
  # Org2: See "Org1" for full specification
  # ---------------------------------------------------------------------------
  - Name: city2            # 配置同上所述
    Domain: city2.epoint.com.cn
    Template:
      Count: 2
    Users:
      Count: 5
```

如上所示，我们在组织机构中定义了4个`Orderer`共识节点，两个组织机构，其中每一个组织机构中包含两个`Peer`节点，每一个组织中预签发了`5`个用户的证书，其中包含一个管理员账户。有了如上的组织机构，我们就可以使用工具进行签发证书。

```bash
Shell> cryptogen generate --config=./crypto-config.yaml
[root@localhost hyperledger1.0.6_conf]# cryptogen generate --config=./crypto-config.yaml
city1.epoint.com.cn
city2.epoint.com.cn
Shell> tree -L 4 crypto-config
crypto-config
├── ordererOrganizations
│   └── epoint.com.cn
│       ├── ca   
│       │   ├── 0b275b1d0864dfad157ad6a6393a4a1ef87ad354618bcfa0d49f74c3add3e818_sk
│       │   └── ca.epoint.com.cn-cert.pem
│       ├── msp
│       │   ├── admincerts
│       │   ├── cacerts
│       │   └── tlscacerts
│       ├── orderers # 每一个Orderer共识节点对应的MSP证书文件
│       │   ├── orderer0.epoint.com.cn 
│       │   ├── orderer1.epoint.com.cn
│       │   ├── orderer2.epoint.com.cn
│       │   └── orderer3.epoint.com.cn
│       ├── tlsca    # TLS加密证书
│       │   ├── 5b42f46d8ae628b93e45e7dc4c502505db57d58d681cca23bbc6a9692f5f1441_sk
│       │   └── tlsca.epoint.com.cn-cert.pem
│       └── users
│           └── Admin@epoint.com.cn
└── peerOrganizations
    ├── city1.epoint.com.cn
    │   ├── ca       # city1组织结构的CA根证书
    │   │   ├── 053ec57e47cd3b71a22414bf28d87dbddec780f01b639be6c99efb8695308f45_sk
    │   │   └── ca.city1.epoint.com.cn-cert.pem
    │   ├── msp      #  city1组织的msp身份证书文件
    │   │   ├── admincerts
    │   │   ├── cacerts
    │   │   └── tlscacerts
    │   ├── peers    #  city1组织机构下的每一个部门的MSP身份证书
    │   │   ├── peer0.city1.epoint.com.cn
    │   │   └── peer1.city1.epoint.com.cn
    │   ├── tlsca    # 节点加密通信的TLS证书
    │   │   ├── 9afd761a385f4f9230b08ff9ffecf8303daa7b566751857ac834e6f16911d46c_sk
    │   │   └── tlsca.city1.epoint.com.cn-cert.pem
    │   └── users    #该组织机构下用户的MSP证书，在调用链码时需要使用到
    │       ├── Admin@city1.epoint.com.cn
    │       ├── User1@city1.epoint.com.cn
    │       ├── User2@city1.epoint.com.cn
    │       ├── User3@city1.epoint.com.cn
    │       ├── User4@city1.epoint.com.cn
    │       └── User5@city1.epoint.com.cn
    └── city2.epoint.com.cn   # 目录结构同city1
        ├── ca
        ├── msp
        ├── peers
        ├── tlsca
        └── users
```
















## 四、线上增加Peer或者Orderer节点



## 四、参考资料

